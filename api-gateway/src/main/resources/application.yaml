server:
  port: ${SERVER_PORT:8000}
  shutdown: graceful

spring:
  application:
    name: api-gateway
  main:
    web-application-type: reactive
  autoconfigure:
    exclude:
      - com.ejada.shared_starter_ratelimit.RateLimitAutoConfiguration
  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: ${GATEWAY_JWK_SET_URI:}
          issuer-uri: ${GATEWAY_ISSUER_URI:}
  data:
    redis:
      sentinel:
        master: ${REDIS_MASTER:mymaster}
        nodes: ${REDIS_SENTINEL_NODES:redis-sentinel-0.redis-sentinel:26379,redis-sentinel-1.redis-sentinel:26379,redis-sentinel-2.redis-sentinel:26379}
      password: ${REDIS_PASSWORD:}
  cloud:
    compatibility-verifier:
      enabled: false
    gateway:
      x-forwarded:
        enabled: true
        for-enabled: true
        proto-enabled: true
        host-enabled: true
        port-enabled: true
      metrics:
        enabled: true
        tags:
          - tenantId
          - routeId
      httpclient:
        connect-timeout: 5000
        response-timeout: 15s
        pool:
          name: gateway-pool
          type: elastic
          max-idle-time: 60s
          evict-in-background: 30s
      redis-rate-limiter:
        include-headers: true
      default-filters:
        - name: RequestSize
          args:
            maxSize: 10MB
        - name: SaveSession
        - name: AddRequestHeader
          args:
            name: X-Gateway-Trace
            value: "#{T(java.util.UUID).randomUUID()}"
      discovery:
        locator:
          enabled: false
      routes: []
    loadbalancer:
      retry:
        enabled: true
      sticky-session:
        enabled: true
        add-service-instance-cookie: true
        cookie-name: LMS-AFFINITY
    kubernetes:
      reload:
        enabled: true
        mode: event
        monitoring-config-maps: true
        monitoring-secrets: true

management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,env,configprops,gateway
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
    metrics:
      enabled: true
    gateway:
      enabled: true
  tracing:
    sampling:
      probability: ${gateway.optimization.sampling-probability:0.01}
  otlp:
    tracing:
      endpoint: ${OTEL_EXPORTER_OTLP_ENDPOINT:http://otel-collector:4317}
  metrics:
    tags:
      application: ${spring.application.name}
      region: ${GCP_REGION:unknown}

shared:
  security:
    resource-server:
      enabled: false
      allowed-origins:
        - https://lms.example.com
        - https://admin.lms.example.com
      permit-all:
        - /actuator/health/**
        - /actuator/info
        - /actuator/prometheus
      disable-csrf: true
      jwk-set-uri: ${spring.security.oauth2.resourceserver.jwt.jwk-set-uri}
      issuer-uri: ${spring.security.oauth2.resourceserver.jwt.issuer-uri}
    cors:
      allow-credentials: false
      max-age: 3600
  core:
    tenant:
      enabled: true
      header-name: X-Tenant-Id
      query-param: tenantId
      resolve-from-jwt: true
      jwt-claim-names:
        - tenant_id
        - tid
      prefer-header-over-jwt: true
      skip-patterns:
        - /actuator/.*
        - /favicon.ico
    correlation:
      enabled: true
      header-name: X-Correlation-Id
      echo-response-header: true
      generate-if-missing: true
      skip-patterns:
        - /actuator/.*
  observability:
    application-name: ${spring.application.name}
  ratelimit:
    enabled: true
    capacity: 200
    window: 1m
    key-strategy: tenant

resilience4j:
  circuitbreaker:
    configs:
      default:
        sliding-window-size: 50
        minimum-number-of-calls: 20
        failure-rate-threshold: 50
        slow-call-rate-threshold: 50
        slow-call-duration-threshold: 2s
        wait-duration-in-open-state: 30s
        permitted-number-of-calls-in-half-open-state: 5
        automatic-transition-from-open-to-half-open-enabled: true
    instances:
      tenant-service:
        base-config: default
      catalog-service:
        base-config: default
      subscription-service:
        base-config: default
      billing-service:
        base-config: default
      setup-service:
        base-config: default
      policy-service:
        base-config: default
      tenant-service-canary:
        base-config: default
  retry:
    configs:
      default:
        max-attempts: 3
        wait-duration: 200ms
        enable-exponential-backoff: true
        exponential-backoff-multiplier: 2
        retry-exceptions:
          - java.io.IOException
          - org.springframework.web.reactive.function.client.WebClientResponseException
    instances:
      catalog-service:
        base-config: default
      policy-service:
        base-config: default
      tenant-service:
        base-config: default
  bulkhead:
    configs:
      default:
        max-concurrent-calls: 50
        max-wait-duration: 1s
    instances:
      tenant-service:
        base-config: default
      policy-service:
        base-config: default

# Declarative downstream routes consumed by GatewayRoutesConfiguration
gateway:
  optimization:
    enabled: ${gateway.optimization.enabled:true}
    sampling-probability: ${gateway.optimization.sampling-probability:0.01}
    warmup-tenants: []
    warmup-timeout: 10s
  dr:
    enabled: ${gateway.dr.enabled:false}
    primary-region: ${PRIMARY_REGION:primary}
    backup-regions: []
    failure-threshold: 5
    failure-window: 30s
    recovery-window: 5m
  bff:
    dashboard:
      tenant-service-uri: lb://tenant-service
      analytics-service-uri: lb://analytics-service
      billing-service-uri: lb://billing-service
      default-period: MONTHLY
  defaults:
    resilience:
      enabled: true
      fallback-uri: forward:/fallback/default
      fallback-status: SERVICE_UNAVAILABLE
      retry:
        enabled: true
        retries: 2
        methods:
          - GET
        statuses:
          - BAD_GATEWAY
          - SERVICE_UNAVAILABLE
        backoff:
          enabled: true
          first-backoff: 100ms
          max-backoff: 2s
          factor: 2
          based-on-previous-value: true
  subscription:
    enabled: true
    validation-uri: lb://subscription-service/internal/subscriptions/{tenantId}
    cache-ttl: 5m
    fail-open: true
    validate-all-routes: true
    skip-patterns:
      - /actuator/**
      - /fallback/**
    required-features:
      catalog-service: catalog.read
      billing-service: billing.manage
      subscription-service: subscription.manage
      policy-service: policy.manage
  webclient:
    connect-timeout: 3s
    response-timeout: 15s
    read-timeout: 10s
    write-timeout: 10s
    max-in-memory-size: 5242880
    pool:
      max-connections: 200
      pending-acquire-max-count: 500
      max-idle-time: 30s
      max-life-time: 10m
      evict-in-background: 30s
      acquire-timeout: 5s
      metrics-enabled: true
  routes:
    setup:
      id: setup-service
      uri: lb://setup-service
      paths:
        - /api/setup/**
      strip-prefix: 1
      prefix-path: /core
      resilience:
        enabled: true
        circuit-breaker-name: setup-service
        fallback-uri: forward:/fallback/setup-service
    tenant:
      id: tenant-service
      uri: lb://tenant-service
      paths:
        - /api/v1/tenants/**
        - /api/tenants/**
        - /api/tenant/**
      strip-prefix: 1
      versioning:
        enabled: true
        default-version: v1
        supported-versions:
          - v1
        fallback-to-default: true
        propagate-header: true
      session-affinity:
        enabled: true
        cookie-name: LMS-TENANT-AFFINITY
        header-name: X-Tenant-Affinity
      weight:
        enabled: true
        group: tenant-service
        value: 90
      request-headers:
        X-Gateway-Track: primary
      resilience:
        enabled: true
        circuit-breaker-name: tenant-service
        fallback-uri: forward:/fallback/tenant-service
    tenant-canary:
      id: tenant-service-canary
      uri: lb://tenant-service
      paths:
        - /api/v1/tenants/**
        - /api/tenants/**
        - /api/tenant/**
      strip-prefix: 1
      versioning:
        enabled: true
        default-version: v1
        supported-versions:
          - v1
      session-affinity:
        enabled: true
        cookie-name: LMS-TENANT-AFFINITY
        header-name: X-Tenant-Affinity
      weight:
        enabled: true
        group: tenant-service
        value: 10
      request-headers:
        X-Gateway-Track: canary
      resilience:
        enabled: true
        circuit-breaker-name: tenant-service-canary
        fallback-uri: forward:/fallback/tenant-service
    catalog:
      id: catalog-service
      uri: lb://catalog-service
      paths:
        - /api/v1/catalog/**
        - /api/catalog/**
      strip-prefix: 1
      versioning:
        enabled: true
        default-version: v1
        supported-versions:
          - v1
      resilience:
        enabled: true
        circuit-breaker-name: catalog-service
        fallback-uri: forward:/fallback/catalog-service
        fallback-message: Catalog service is currently unavailable. Please retry shortly.
        retry:
          enabled: true
          retries: 3
          methods:
            - GET
          statuses:
            - 500
            - BAD_GATEWAY
          series:
            - SERVER_ERROR
          backoff:
            enabled: true
            first-backoff: 100ms
            max-backoff: 3s
            factor: 1.5
            based-on-previous-value: true
    subscription:
      id: subscription-service
      uri: lb://subscription-service
      paths:
        - /api/v1/subscriptions/**
        - /api/subscriptions/**
        - /api/subscription/**
      strip-prefix: 1
      versioning:
        enabled: true
        default-version: v1
        supported-versions:
          - v1
      resilience:
        enabled: true
        circuit-breaker-name: subscription-service
        fallback-uri: forward:/fallback/subscription-service
    billing:
      id: billing-service
      uri: lb://billing-service
      paths:
        - /api/v1/billing/**
        - /api/billing/**
      strip-prefix: 1
      versioning:
        enabled: true
        default-version: v1
        supported-versions:
          - v1
      resilience:
        enabled: true
        circuit-breaker-name: billing-service
        fallback-uri: forward:/fallback/billing-service
    policy:
      id: policy-service
      uri: lb://policy-service
      paths:
        - /api/v1/policies/**
        - /api/policies/**
      strip-prefix: 1
      versioning:
        enabled: true
        default-version: v1
        supported-versions:
          - v1
      resilience:
        enabled: true
        circuit-breaker-name: policy-service
        fallback-uri: forward:/fallback/default
  admin:
    aggregation:
      timeout: 3s
      services:
        - id: tenant-service
          uri: lb://tenant-service
          health-path: /actuator/health
          required: true
          deployment: primary
        - id: tenant-service-canary
          uri: lb://tenant-service
          health-path: /actuator/health
          required: false
          deployment: canary
          headers:
            X-Gateway-Track: canary
        - id: catalog-service
          uri: lb://catalog-service
          health-path: /actuator/health
          required: true
          deployment: primary
        - id: subscription-service
          uri: lb://subscription-service
          health-path: /actuator/health
          required: true
          deployment: primary
        - id: billing-service
          uri: lb://billing-service
          health-path: /actuator/health
          required: true
          deployment: primary
        - id: policy-service
          uri: lb://policy-service
          health-path: /actuator/health
          required: true
          deployment: primary

logging:
  level:
    root: INFO
    com.ejada.gateway: DEBUG
  pattern:
    level: "%5p [${spring.application.name},trace=%X{traceId:-},span=%X{spanId:-},tenant=%X{tenantId:-}]"

reactor:
  context-propagation: auto
  netty:
    ioWorkerCount: ${REACTOR_NETTY_IO_WORKERS:0}

