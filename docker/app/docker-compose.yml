version: "3.8"

# ----------------------------- #
#          Reusable bits        #
# ----------------------------- #
x-restart: &restart_policy
  restart: unless-stopped

x-common-env: &common_env
  TZ: Asia/Riyadh
  SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/ne
  SPRING_DATASOURCE_USERNAME: postgres
  SPRING_DATASOURCE_PASSWORD: postgres
  SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
  OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
  OTEL_TRACES_EXPORTER: otlp
  OTEL_METRICS_EXPORTER: otlp

x-core-dependencies: &core_dependencies
  postgres: { condition: service_healthy }
  otel-collector: { condition: service_started }
  kafka: { condition: service_healthy }

networks:
  backend:
    driver: bridge

# ----------------------------- #
#       Application stack       #
# ----------------------------- #
services:
  tenant-service:
    build: ./tenant-platform/tenant-service
    <<: [*restart_policy]
    depends_on:
      <<: *core_dependencies
    environment:
      <<: *common_env
      OTEL_SERVICE_NAME: tenant-service
    ports:
      - "8080:8080"
    networks:
      backend:

  setup-service:
    build: ./setup-service
    <<: [*restart_policy]
    depends_on:
      <<: *core_dependencies
    environment:
      <<: *common_env
      OTEL_SERVICE_NAME: setup-service
    ports:
      - "8081:8080"
    networks:
      backend:

  billing-service:
    build: ./tenant-platform/billing-service
    <<: [*restart_policy]
    depends_on:
      <<: *core_dependencies
    environment:
      <<: *common_env
      OTEL_SERVICE_NAME: billing-service
    ports:
      - "8082:8080"
    networks:
      backend:

  catalog-service:
    build: ./tenant-platform/catalog-service
    <<: [*restart_policy]
    depends_on:
      <<: *core_dependencies
    environment:
      <<: *common_env
      OTEL_SERVICE_NAME: catalog-service
    ports:
      - "8083:8080"
    networks:
      backend:

  subscription-service:
    build: ./tenant-platform/subscription-service
    <<: [*restart_policy]
    depends_on:
      <<: *core_dependencies
    environment:
      <<: *common_env
      OTEL_SERVICE_NAME: subscription-service
    ports:
      - "8084:8080"
    networks:
      backend:

  security-service:
    build: ./sec-service
    <<: [*restart_policy]
    depends_on:
      <<: *core_dependencies
      redis: { condition: service_healthy }
    environment:
      <<: *common_env
      OTEL_SERVICE_NAME: security-service

      # --- Redis via shared-lib (fixes localhost issue in containers) ---
      SHARED_REDIS_HOST: redis
      SHARED_REDIS_PORT: 6379
      SHARED_REDIS_TIMEOUT: 5s
      SHARED_REDIS_KEY_PREFIX: security
      SHARED_REDIS_DEFAULT_TTL: 600s
      # Some Spring parts may read spring.data.redis.* directly:
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
    ports:
      - "8085:8080"
    networks:
      backend:

  admin-service:
    build: ./admin-service
    <<: [*restart_policy]
    depends_on:
      <<: *core_dependencies
    environment:
      <<: *common_env
      OTEL_SERVICE_NAME: admin-service
    ports:
      - "8086:8080"
    networks:
      backend:

  email-template-service:
    build: ./email-management/email-template-service
    <<: [*restart_policy]
    depends_on:
      <<: *core_dependencies
      redis: { condition: service_healthy }
    environment:
      <<: *common_env
      OTEL_SERVICE_NAME: email-template-service
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
    ports:
      - "8091:8081"
    networks:
      backend:

  email-sending-service:
    build: ./email-management/email-sending-service
    <<: [*restart_policy]
    depends_on:
      <<: *core_dependencies
      redis: { condition: service_healthy }
    environment:
      <<: *common_env
      OTEL_SERVICE_NAME: email-sending-service
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
    ports:
      - "8092:8082"
    networks:
      backend:

  email-webhook-service:
    build: ./email-management/email-webhook-service
    <<: [*restart_policy]
    depends_on:
      <<: *core_dependencies
      redis: { condition: service_healthy }
    environment:
      <<: *common_env
      OTEL_SERVICE_NAME: email-webhook-service
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
    ports:
      - "8093:8083"
    networks:
      backend:

  email-usage-service:
    build: ./email-management/email-usage-service
    <<: [*restart_policy]
    depends_on:
      <<: *core_dependencies
    environment:
      <<: *common_env
      OTEL_SERVICE_NAME: email-usage-service
    ports:
      - "8094:8084"
    networks:
      backend:
