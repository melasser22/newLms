version: "3.8"

# ----------------------------- #
#          Reusable bits        #
# ----------------------------- #
x-restart: &restart_policy
  restart: unless-stopped

networks:
  backend:
    driver: bridge

# ----------------------------- #
#       Application stack       #
# ----------------------------- #
services:
  tenant-service:
    build: ./tenant-platform/tenant-service
    <<: [*restart_policy]
    depends_on:
      postgres: { condition: service_healthy }
      otel-collector: { condition: service_started }
    environment:
      TZ: Asia/Riyadh
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/lms
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      OTEL_SERVICE_NAME: tenant-service
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
      OTEL_TRACES_EXPORTER: otlp
      OTEL_METRICS_EXPORTER: otlp
      # If this service uses Redis via shared-lib, uncomment:
      # SHARED_REDIS_HOST: redis
      # SHARED_REDIS_PORT: 6379
      # SHARED_REDIS_TIMEOUT: 5s
      # SPRING_DATA_REDIS_HOST: redis
      # SPRING_DATA_REDIS_PORT: 6379
    ports:
      - "8080:8080"
    networks:
      backend:

  setup-service:
    build: ./setup-service
    <<: [*restart_policy]
    depends_on:
      postgres: { condition: service_healthy }
      otel-collector: { condition: service_started }
    environment:
      TZ: Asia/Riyadh
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/lms
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      OTEL_SERVICE_NAME: setup-service
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
      OTEL_TRACES_EXPORTER: otlp
      OTEL_METRICS_EXPORTER: otlp
      # Optional Redis bindings (see note above)
      # SHARED_REDIS_HOST: redis
      # SHARED_REDIS_PORT: 6379
      # SHARED_REDIS_TIMEOUT: 5s
      # SPRING_DATA_REDIS_HOST: redis
      # SPRING_DATA_REDIS_PORT: 6379
    ports:
      - "8081:8080"
    networks:
      backend:

  billing-service:
    build: ./tenant-platform/billing-service
    <<: [*restart_policy]
    depends_on:
      postgres: { condition: service_healthy }
      otel-collector: { condition: service_started }
    environment:
      TZ: Asia/Riyadh
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/lms
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      OTEL_SERVICE_NAME: billing-service
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
      OTEL_TRACES_EXPORTER: otlp
      OTEL_METRICS_EXPORTER: otlp
      # Optional Redis bindings
      # SHARED_REDIS_HOST: redis
      # SHARED_REDIS_PORT: 6379
      # SHARED_REDIS_TIMEOUT: 5s
      # SPRING_DATA_REDIS_HOST: redis
      # SPRING_DATA_REDIS_PORT: 6379
    ports:
      - "8082:8080"
    networks:
      backend:

  catalog-service:
    build: ./tenant-platform/catalog-service
    <<: [*restart_policy]
    depends_on:
      postgres: { condition: service_healthy }
      otel-collector: { condition: service_started }
    environment:
      TZ: Asia/Riyadh
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/lms
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      OTEL_SERVICE_NAME: catalog-service
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
      OTEL_TRACES_EXPORTER: otlp
      OTEL_METRICS_EXPORTER: otlp
      # Optional Redis bindings
      # SHARED_REDIS_HOST: redis
      # SHARED_REDIS_PORT: 6379
      # SHARED_REDIS_TIMEOUT: 5s
      # SPRING_DATA_REDIS_HOST: redis
      # SPRING_DATA_REDIS_PORT: 6379
    ports:
      - "8083:8080"
    networks:
      backend:

  subscription-service:
    build: ./tenant-platform/subscription-service
    <<: [*restart_policy]
    depends_on:
      postgres: { condition: service_healthy }
      otel-collector: { condition: service_started }
    environment:
      TZ: Asia/Riyadh
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/lms
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      OTEL_SERVICE_NAME: subscription-service
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
      OTEL_TRACES_EXPORTER: otlp
      OTEL_METRICS_EXPORTER: otlp
      # Optional Redis bindings
      # SHARED_REDIS_HOST: redis
      # SHARED_REDIS_PORT: 6379
      # SHARED_REDIS_TIMEOUT: 5s
      # SPRING_DATA_REDIS_HOST: redis
      # SPRING_DATA_REDIS_PORT: 6379
    ports:
      - "8084:8080"
    networks:
      backend:

  security-service:
    build: ./sec-service
    <<: [*restart_policy]
    depends_on:
      postgres: { condition: service_healthy }
      redis: { condition: service_healthy }
      otel-collector: { condition: service_started }
    environment:
      TZ: Asia/Riyadh

      # --- Database ---
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/lms
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres

      # --- Redis via shared-lib (fixes localhost issue in containers) ---
      SHARED_REDIS_HOST: redis
      SHARED_REDIS_PORT: 6379
      SHARED_REDIS_TIMEOUT: 5s
      SHARED_REDIS_KEY_PREFIX: security
      SHARED_REDIS_DEFAULT_TTL: 600s
      # Some Spring parts may read spring.data.redis.* directly:
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379

      # --- Observability ---
      OTEL_SERVICE_NAME: security-service
      OTEL_EXPORTER_OTLP_ENDPOINT: http://otel-collector:4317
      OTEL_TRACES_EXPORTER: otlp
      OTEL_METRICS_EXPORTER: otlp
    ports:
      - "8085:8080"
    networks:
      backend:
