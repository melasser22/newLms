config:
  application: |
    server:
      port: ${SERVER_PORT:8000}
      shutdown: graceful
    
    spring:
      config:
        import:
          - "optional:configserver:${spring.cloud.config.uri:${SPRING_CLOUD_CONFIG_URI:http://config-server:8888}}"
          - "classpath:gateway.yml"
          - "classpath:routes.yml"
          - "classpath:security.yml"
          - "classpath:tenant.yml"
          - "classpath:resilience.yml"
          - "classpath:logging.yml"
      application:
        name: api-gateway
        admin:
          enabled: true
      main:
        lazy-initialization: true
        web-application-type: reactive
      output:
        ansi:
          enabled: ALWAYS
      boot:
        startup: info
      data:
        redis:
          repositories:
            enabled: false
      autoconfigure:
        exclude:
          - com.ejada.shared_starter_ratelimit.RateLimitAutoConfiguration
      kafka:
        listener:
          concurrency: 2
          auto-startup: false
      cloud:
        config:
          enabled: ${SPRING_CLOUD_CONFIG_ENABLED:true}
          uri: ${SPRING_CLOUD_CONFIG_URI:http://config-server:8888}
          profile: ${SPRING_CLOUD_CONFIG_PROFILE:${SPRING_PROFILES_ACTIVE:local}}
          label: ${SPRING_CLOUD_CONFIG_LABEL:main}
          username: ${SPRING_CLOUD_CONFIG_USERNAME:}
          password: ${SPRING_CLOUD_CONFIG_PASSWORD:}
          fail-fast: ${SPRING_CLOUD_CONFIG_FAIL_FAST:false}
      r2dbc:
        url: ${SPRING_R2DBC_URL:${GATEWAY_R2DBC_URL:r2dbc:postgresql://postgres:5432/lms}}
        username: ${SPRING_R2DBC_USERNAME:${GATEWAY_R2DBC_USERNAME:postgres}}
        password: ${SPRING_R2DBC_PASSWORD:${GATEWAY_R2DBC_PASSWORD:postgres}}
      sql:
        init:
          mode: ${SPRING_SQL_INIT_MODE:never}
          schema-locations: classpath:schema.sql
        compatibility-verifier:
          enabled: false
    
    shared:
      patterns:
        docs:
          api-v3-single: &pattern-docs-api-v3-single /api/*/v3/api-docs/**
          api-v3-double: &pattern-docs-api-v3-double /api/*/*/v3/api-docs/**
          api-swagger-single: &pattern-docs-api-swagger-single /api/*/swagger-ui/**
          api-swagger-double: &pattern-docs-api-swagger-double /api/*/*/swagger-ui/**
          api-swagger-html-single: &pattern-docs-api-swagger-html-single /api/*/swagger-ui.html
          api-swagger-html-double: &pattern-docs-api-swagger-html-double /api/*/*/swagger-ui.html
          root-v3: &pattern-docs-root-v3 /v3/api-docs/**
          root-swagger: &pattern-docs-root-swagger /swagger-ui/**
          root-swagger-html: &pattern-docs-root-swagger-html /swagger-ui.html
        actuator:
          health: &pattern-actuator-health /actuator/health/**
          info: &pattern-actuator-info /actuator/info
          prometheus: &pattern-actuator-prometheus /actuator/prometheus
          generic: &pattern-actuator-generic /actuator/**
        auth:
          login: &pattern-auth-login /auth/admin/login
          api-auth: &pattern-auth-api /api/auth/**
          api-auth-superadmin: &pattern-auth-api-superadmin /api/auth/superadmin/**
          api-auth-v1: &pattern-auth-api-v1 /api/v1/auth/**
          api-auth-sec: &pattern-auth-sec /api/auth/**
          api-v1-superadmin: &pattern-auth-api-v1-superadmin /api/v1/superadmin/**
          api-sec-superadmin: &pattern-auth-sec-superadmin /api/v1/superadmin/**
          auth-admin: &pattern-auth-admin /api/auth/admin/login
          auth-sec-admin: &pattern-auth-sec-admin /api/auth/admin/login
          auth-root: &pattern-auth-root /auth/**
        misc:
          favicon: &pattern-misc-favicon /favicon.ico
          fallback: &pattern-fallback /fallback/**
          auth-root-sec: &pattern-auth-root-sec /api/v1/auth/**
    
    app:
      env: ${APP_ENV:${SPRING_PROFILES_ACTIVE:local}}
      version: ${APP_VERSION:1.0.0}
      configuration-version: ${APP_CONFIGURATION_VERSION:${app.configuration-version:1}}
    
    jasypt:
      encryptor:
        password: ${JASYPT_ENCRYPTOR_PASSWORD}
        algorithm: PBEWITHHMACSHA512ANDAES_256
        key-obtention-iterations: 1000
        pool-size: 1
        provider-name: SunJCE
        salt-generator-classname: org.jasypt.salt.RandomSaltGenerator
        iv-generator-classname: org.jasypt.iv.RandomIvGenerator
        string-output-type: base64
        fail-on-missing-password: ${JASYPT_ENCRYPTOR_FAIL_ON_MISSING_PASSWORD:true}
        property:
          prefix: ENC(
          suffix: )
  gateway: |
    spring:
      cloud:
        gateway:
          default-filters: &gateway-default-filters
            - name: RequestSize
              args:
                maxSize: 10MB
            - name: SaveSession
            - name: AddRequestHeader
              args:
                name: X-Gateway-Trace
                value: "#{T(java.util.UUID).randomUUID()}"
          x-forwarded:
            enabled: true
            for-enabled: true
            proto-enabled: true
            host-enabled: true
            port-enabled: true
          metrics:
            enabled: true
            tags:
              - tenantId
              - routeId
          httpclient:
            connect-timeout: 5000
            response-timeout: 15s
            pool:
              name: gateway-pool
              type: elastic
              max-idle-time: 60s
              evict-in-background: 30s
          redis-rate-limiter:
            include-headers: true
          discovery:
            locator:
              enabled: false
          routes: []
        loadbalancer:
          client:
            name: ${SPRING_CLOUD_LOADBALANCER_CLIENT_NAME:${spring.application.name}}
          retry:
            enabled: true
          sticky-session:
            enabled: true
            add-service-instance-cookie: true
            cookie-name: LMS-AFFINITY
        kubernetes:
          enabled: ${SPRING_CLOUD_KUBERNETES_ENABLED:false}
          discovery:
            enabled: ${SPRING_CLOUD_KUBERNETES_DISCOVERY_ENABLED:${spring.cloud.kubernetes.enabled}}
            all-namespaces: false
            include-not-ready-addresses: false
            wait-cache-ready: true
            cache-loading-timeout-seconds: 30
            namespaces:
              - ${SPRING_CLOUD_KUBERNETES_DISCOVERY_NAMESPACE:${KUBERNETES_NAMESPACE:}}
            metadata:
              add-pod-labels: true
              add-pod-annotations: true
          loadbalancer:
            enabled: ${SPRING_CLOUD_KUBERNETES_LOADBALANCER_ENABLED:${spring.cloud.kubernetes.enabled}}
            mode: POD
          reload:
            enabled: true
            mode: event
            monitoring-config-maps: true
            monitoring-secrets: true
    
    gateway:
      internal:
        api-key: ${GATEWAY_INTERNAL_API_KEY:${SHARED_SECURITY_INTERNAL_CLIENT_API_KEY:local-dev-internal-key}}
      tracing:
        enhanced-tags:
          enabled: true
      bff:
        dashboard:
          tenant-service-uri: lb://tenant-service
      security:
        signature-validation:
          enabled: false
          skip-patterns:
            - /public/**
            - ${shared.patterns.actuator.generic}
            - ${shared.patterns.auth.auth-root}
        api-key:
          enabled: true
          encryption:
            enabled: true
            algorithm: AES-256-GCM
            key-id: default
            key-value: ${GATEWAY_API_KEY_ENCRYPTION_KEY:}
          rotation:
            enabled: true
            max-age-days: 90
          scope-enforcement:
            enabled: true
            require-exact-match: false
          audit:
            log-usage: true
            track-last-used: true
        token-cache:
          enabled: false
          ttl: 15m
        ip-filtering:
          enabled: false
          analytics-service-uri: lb://analytics-service
          billing-service-uri: lb://billing-service
          default-period: MONTHLY
      defaults:
        max-request-size: 10MB
        routes:
          tenant-service: &defaults-tenant-route
            uri: lb://tenant-service
            paths:
              - /api/v1/tenants/**
              - /api/tenants/**
              - /api/tenant/**
            strip-prefix: 0
            prefix-path: /tenant
            versioning: &defaults-tenant-versioning
              enabled: true
              default-version: v1
              supported-versions:
                - v1
            session-affinity:
              enabled: true
              cookie-name: LMS-TENANT-AFFINITY
              header-name: X-Tenant-Affinity
        resilience:
          enabled: true
          fallback-uri: forward:/fallback/default
          fallback-status: SERVICE_UNAVAILABLE
          priority: NON_CRITICAL
          retry:
            enabled: true
            retries: 2
            methods:
              - GET
            statuses:
              - BAD_GATEWAY
              - SERVICE_UNAVAILABLE
            backoff:
              enabled: true
              first-backoff: 100ms
              max-backoff: 2s
              factor: 2
              based-on-previous-value: true
      logging:
        access-log:
          enabled: true
          skip-patterns:
            - ${shared.patterns.actuator.generic}
            - /health
      cache:
        enabled: true
        warm-interval: 10m
        warm-on-startup: false
        warm-tenants:
          - demo
        topics:
          tenant-updated: tenant.updated
          catalog-plan-updated: catalog.plan.updated
          subscription-changed: subscription.changed
        kafka:
          group-id: gateway-cache
        smart:
          patterns:
            - name: catalog
              path: /api/v1/catalog/**
              ttl: 5m
            - name: tenant
              path: /api/v1/tenants/**
              ttl: 1m
        routes:
          - &cache-client-base
            id: catalog-plans
            route-id: catalog-service
            method: GET
            path: /api/v1/catalog/plans
            ttl: 0s
            warm: true
            tenant-scoped: true
            client: &cache-client-config
              authorization: ${GATEWAY_CACHE_CATALOG_AUTHORIZATION:}
              api-key: ${GATEWAY_CACHE_CATALOG_API_KEY:}
              timeout: ${GATEWAY_CACHE_CLIENT_TIMEOUT:10s}
              headers:
                X-Internal-Request: "true"
          - <<: *cache-client-base
            id: catalog-features
            path: /api/v1/catalog/features
          - id: tenant-by-id
            route-id: tenant-service
            method: GET
            path: /api/v1/tenants/{id}
            ttl: 0s
            warm: false
            tenant-scoped: true
      subscription:
        enabled: true
        validation-uri: lb://subscription-service/internal/subscriptions/{tenantId}
        cache-ttl: 5m
        cache-prefix: "gateway:subscription:"
        fail-open: true
        validate-all-routes: true
        skip-patterns:
          - ${shared.patterns.actuator.generic}
          - ${shared.patterns.misc.fallback}
          - ${shared.patterns.auth.auth-root}
          - ${shared.patterns.misc.auth-root-sec}
          - ${shared.patterns.auth.api-auth}
          - ${shared.patterns.auth.api-auth-superadmin}
          - ${shared.patterns.auth.api-auth-v1}
          - ${shared.patterns.auth.api-auth-sec}
          - ${shared.patterns.auth.api-v1-superadmin}
          - ${shared.patterns.auth.api-sec-superadmin}
          - ${shared.patterns.docs.api-swagger-single}
          - ${shared.patterns.docs.api-swagger-double}
          - ${shared.patterns.docs.api-v3-single}
          - ${shared.patterns.docs.api-v3-double}
          - ${shared.patterns.docs.root-swagger}
          - ${shared.patterns.docs.root-v3}
        required-features:
          catalog-service: catalog.read
          billing-service: billing.manage
          subscription-service: subscription.manage
        warmup:
          enabled: true
          tenant-service-uri: lb://tenant-service/api/v1/tenants
          refresh-interval: PT2M
          page-size: 200
          policy-service: policy.manage
      webclient:
        connect-timeout: 3s
        response-timeout: 15s
        read-timeout: 10s
        write-timeout: 10s
        max-in-memory-size: 5242880
      admin:
        aggregation:
          timeout: 3s
          services:
            - id: tenant-service
              uri: lb://tenant-service
              health-path: /actuator/health
              required: true
              deployment: primary
            - id: tenant-service-canary
              uri: lb://tenant-service
              health-path: /actuator/health
              required: false
              deployment: canary
              headers:
                X-Gateway-Track: canary
            - id: catalog-service
              uri: lb://catalog-service
              health-path: /actuator/health
              required: true
              deployment: primary
            - id: subscription-service
              uri: lb://subscription-service
              health-path: /actuator/health
              required: true
              deployment: primary
            - id: billing-service
              uri: lb://billing-service
              health-path: /actuator/health
              required: true
              deployment: primary
            - id: setup-service
              uri: lb://setup-service
              health-path: /actuator/health
              required: true
              deployment: primary
            - id: security-service
              uri: lb://security-service
              health-path: /actuator/health
              required: true
              deployment: primary
            - id: policy-service
              uri: lb://policy-service
              health-path: /actuator/health
              required: false
              deployment: primary
  routes: |
    gateway:
      versioning:
        enabled: true
        compatibility:
          matrix:
            v2:
              - v1
        mappings:
          - &tenant-versioning-base
            id: tenant-api
            description: Normalize legacy tenant endpoints to v2 implementations
            default-version: v2
            legacy-paths:
              - /v1/tenants/{*remaining}
              - /api/v1/tenants/{*remaining}
            routes:
              - version: v1
                target-version: v2
                rewrite-path: /v2/tenants/{remaining}
                weight: 90
                deprecated: true
                warning: "Tenant API v1 is deprecated and will be removed. Use Accept-Version: v2."
                sunset: 2024-12-31T00:00:00Z
                policy-link: https://docs.example.com/tenant-api-deprecation
                compatibility:
                  - v1
                  - v2
                additional-headers:
                  X-Gateway-Track: primary
              - version: v1
                target-version: v2
                rewrite-path: /v2/tenants/{remaining}
                weight: 10
                deprecated: true
                warning: Tenant API v1 is being migrated to v2 rollout track.
                sunset: 2024-12-31T00:00:00Z
                documentation-group: tenant-api-v2-canary
                additional-headers:
                  X-Gateway-Track: canary
              - version: v2
                rewrite-path: /v2/tenants/{remaining}
                weight: 100
                compatibility:
                  - v2
                documentation-group: tenant-api-v2
      routes: {}
  security: |
    spring:
      security:
        oauth2:
          resourceserver:
            jwt:
              jwk-set-uri: ${GATEWAY_JWK_SET_URI:}
              issuer-uri: ${GATEWAY_ISSUER_URI:}
    
    security:
      resource-server:
        enabled: false
        allowed-origins:
          - https://lms.example.com
          - https://admin.lms.example.com
        permit-all: &security-permit-all
          - ${shared.patterns.auth.api-auth}
          - ${shared.patterns.auth.api-auth-superadmin}
          - ${shared.patterns.auth.api-auth-v1}
          - ${shared.patterns.auth.api-auth-sec}
          - ${shared.patterns.auth.api-v1-superadmin}
          - ${shared.patterns.auth.api-sec-superadmin}
          - ${shared.patterns.auth.auth-admin}
          - ${shared.patterns.auth.auth-sec-admin}
          - ${shared.patterns.auth.auth-root}
          - ${shared.patterns.auth.login}
          - ${shared.patterns.actuator.health}
          - ${shared.patterns.actuator.info}
          - ${shared.patterns.actuator.prometheus}
          - ${shared.patterns.docs.api-v3-single}
          - ${shared.patterns.docs.api-v3-double}
          - ${shared.patterns.docs.api-swagger-single}
          - ${shared.patterns.docs.api-swagger-double}
          - ${shared.patterns.docs.api-swagger-html-single}
          - ${shared.patterns.docs.api-swagger-html-double}
          - ${shared.patterns.docs.root-v3}
          - ${shared.patterns.docs.root-swagger}
          - ${shared.patterns.docs.root-swagger-html}
        disable-csrf: true
        jwk-set-uri: ${spring.security.oauth2.resourceserver.jwt.jwk-set-uri}
        issuer-uri: ${spring.security.oauth2.resourceserver.jwt.issuer-uri}
      cors:
        allow-credentials: false
        max-age: 3600
  tenant: |
    core:
      tenant:
        enabled: true
        header-name: X-Tenant-Id
        query-param: tenantId
        resolve-from-jwt: true
        jwt-claim-names:
          - tenant_id
          - tid
        prefer-header-over-jwt: true
        skip-patterns:
          - ${shared.patterns.actuator.generic}
          - ${shared.patterns.misc.favicon}
          - ${shared.patterns.docs.api-v3-single}
          - ${shared.patterns.docs.api-v3-double}
          - ${shared.patterns.docs.api-swagger-single}
          - ${shared.patterns.docs.api-swagger-double}
          - ${shared.patterns.docs.api-swagger-html-single}
          - ${shared.patterns.docs.api-swagger-html-double}
          - ${shared.patterns.auth.api-auth}
          - ${shared.patterns.auth.api-auth-superadmin}
          - ${shared.patterns.auth.api-auth-sec}
          - ${shared.patterns.auth.api-v1-superadmin}
          - ${shared.patterns.auth.api-sec-superadmin}
          - ${shared.patterns.docs.root-v3}
          - ${shared.patterns.docs.root-swagger}
          - ${shared.patterns.docs.root-swagger-html}
      correlation:
        enabled: true
        header-name: X-Correlation-Id
        echo-response-header: true
        generate-if-missing: true
        skip-patterns:
          - ${shared.patterns.actuator.generic}
    
    observability:
      application-name: ${spring.application.name}
    
    ratelimit:
      enabled: true
      capacity: 200
      window: 1m
      key-strategy: tenant
  resilience: |
    resilience4j:
      circuitbreaker:
        configs:
          default: &circuitbreaker-default
            sliding-window-size: 50
            minimum-number-of-calls: 20
            failure-rate-threshold: 50
            slow-call-rate-threshold: 50
            slow-call-duration-threshold: 2s
            wait-duration-in-open-state: 30s
            permitted-number-of-calls-in-half-open-state: 5
            automatic-transition-from-open-to-half-open-enabled: true
          critical:
            <<: *circuitbreaker-default
            sliding-window-size: 30
            minimum-number-of-calls: 15
            failure-rate-threshold: 30
            slow-call-duration-threshold: 3s
            wait-duration-in-open-state: 10s
            permitted-number-of-calls-in-half-open-state: 3
          non-critical:
            <<: *circuitbreaker-default
            sliding-window-size: 60
            minimum-number-of-calls: 25
            slow-call-duration-threshold: 3s
            permitted-number-of-calls-in-half-open-state: 6
        instances:
          tenant-service-cb:
            base-config: critical
          catalog-service-cb:
            base-config: non-critical
          subscription-service:
            base-config: critical
          billing-service:
            base-config: critical
          setup-service:
            base-config: non-critical
          policy-service:
            base-config: non-critical
          tenant-service-canary:
            base-config: non-critical
      retry:
        configs:
          default:
            max-attempts: 3
            wait-duration: 200ms
            enable-exponential-backoff: true
            exponential-backoff-multiplier: 2
            retry-exceptions: &retry-exceptions
              - java.io.IOException
              - org.springframework.web.reactive.function.client.WebClientResponseException
        instances:
          catalog-service:
            base-config: default
          policy-service:
            base-config: default
          tenant-service:
            base-config: default
      bulkhead:
        configs:
          default:
            max-concurrent-calls: 50
            max-wait-duration: 1s
        instances:
          tenant-service:
            base-config: default
          policy-service:
            base-config: default
      thread-pool-bulkhead:
        configs:
          default:
            max-thread-pool-size: 30
            core-thread-pool-size: 10
            queue-capacity: 100
            keep-alive-duration: 30s
        instances:
          setup-service-bulkhead:
            base-config: default
          tenant-service-cb-bulkhead:
            base-config: default
          tenant-service-canary-bulkhead:
            base-config: default
          catalog-service-cb-bulkhead:
            base-config: default
          subscription-service-bulkhead:
            base-config: default
          billing-service-bulkhead:
            base-config: default
          security-service-bulkhead:
            base-config: default
          policy-service-bulkhead:
            base-config: default
  logging: |
    logging:
      level:
        root: INFO
        com.ejada.gateway: DEBUG
      pattern:
        level: "%5p [${spring.application.name},trace=%X{traceId:-},span=%X{spanId:-},tenant=%X{tenantId:-}]"
    
    management:
      endpoints:
        web:
          exposure:
            include: health,info,metrics,prometheus,env,configprops,gateway,refresh
      endpoint:
        health:
          show-details: always
          show-components: always
          probes:
            enabled: true
        metrics:
          enabled: true
        gateway:
          enabled: true
      health:
        circuitbreakers:
          enabled: false
        discovery:
          enabled: false
        loadbalancer:
          enabled: false
      tracing:
        sampling:
          probability: 1.0
      otlp:
        tracing:
          endpoint: ${OTEL_EXPORTER_OTLP_ENDPOINT:http://otel-collector:4317}
      metrics:
        tags:
          application: ${spring.application.name}
          region: ${GCP_REGION:unknown}
    
    reactor:
      context-propagation: auto
      netty:
        ioWorkerCount: ${REACTOR_NETTY_IO_WORKERS:0}
secretRefs:
  configServer:
    name: config-server-credentials
    usernameKey: username
    passwordKey: password
  r2dbc:
    name: gateway-r2dbc-credentials
    usernameKey: username
    passwordKey: password
  internalApiKey:
    name: gateway-internal-api
    key: api-key

secrets: {}
